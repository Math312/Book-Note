# 2-2.进程调度

## 1. 调度的概念及层次

`当有一堆任务要处理，但由于资源有限，这些事情没法同时处理。这就需要确定某种规则来决定处理这些任务的顺序`，这就是`调度`。

调度的三个层级：
1. 高级调度
2. 中级调度
3. 低级调度

### 1.1 高级调度（作业调度）

作业：一个具体的任务（可以理解为是启动一个程序）。

`高级调度（作业调度）`：`按一定的原则从外存的作业后备队列中挑选一个作业调入内存，并创建进程`。`每个作业只调入一次，调出一次`。`作业调入时会建立PCB，调出时才撤销PCB`。

常见情况：内存空间有限，有时无法将用户提交的作业全部放入内存。


`高级调度`：`作业在外存与内存之间的调度`。

![](./2-1.png)


### 1.2 中级调度（内存调度）

内存不够时，可将某些进程的数据调出外存。等内存空间或者进程需要运行时再重新调入。

暂时调到外存等待的进程状态为`挂起状态`。被挂起的进程PCB会被组织成`挂起队列`。

`中级调度（内存调度）`：`按照某种策略决定将哪个处于挂起状态的进程调入内存`。一个进程可能会被多次调度、调入内存，因此`中级调度发生的频率要比高级调度更高`。

![](./2-2.png)

### 1.3 低级调度（进程调度/处理机调度）

`低级调度（进程调度/处理机调度）`：`按照某种策略从就绪队列中选取一个进程，将处理机分配给它`。

`进程调度是操作系统中最基本的一种调度`。在一般的操作系统中都必须配置进程调度。进程调度的频率很高，一般几十毫秒一次。

![](./2-4.png)

### 1.4 三种调度对比

| 名称                 | 要做什么                                                             | 调度发生在...          | 发生频率 | 对进程状态的影响                   |
| -------------------- | -------------------------------------------------------------------- | ---------------------- | -------- | ---------------------------------- |
| 高级调度（作业调度） | 按照某种规则，从后备队列中选择合适的作业将其调入内存，并为其创建进程 | 外存->内存（面向作业） | 最低     | 无->创建态->就绪态                 |
| 中级调度（内存调度） | 按照某种规则，从挂起队列中选择何事的进程将其数据调回内存             | 外存->内存（面向进程） | 中等     | 挂起态->就绪态（阻塞挂起->阻塞态） |
| 低级调度（进程调度） | 按照某种规则，从就绪队列中选择一个进程为其分配处理机                 | 内存->CPU              | 最高     | 就绪态->运行态                     |

### 1.5 七状态模型

![](./2-5.png)

暂时调到外存等待的进程状态为`挂起状态`。`挂起态`又可以进一步细分为`就绪挂起`、`阻塞挂起`两种状态。

- 就绪态->就绪挂起态：内存不够
- 阻塞态->阻塞挂起态：内存不够
- 就绪挂起态->就绪态：内存够了
- 阻塞挂起态->阻塞态：内存够了
- 阻塞挂起态->就绪挂起态：等待事件出现

注意：
1. 挂起vs阻塞：
   1. 共同点：都暂时不能获取到CPU的服务
   2. 区别：挂起态将进程映像调到外存去了。阻塞态下进程的映像在内存。

## 2. 进程调度的时机

1. `需要进行进程调度与切换的情况`：
   1. `当前运行的进程主动放弃处理机`：
      1. 进程正常终止
      2. 运行过程中发生异常而终止
      3. 进程主动请求阻塞（如等待I/O）
    2. `当前运行的进程被动放弃处理机`：
       1. 分给进程的时间片用完
       2. 有更紧急的事情需要处理（如I/O中断）
       3. 有更高优先级的进程进入就绪队列
2. `不能进行进程调度与切换的情况`：
   1. `在处理中断的过程中`。`中断处理过程复杂，与硬件密切相关，很难做到在中断处理过程中进程切换`。
   2. 进程在`操作系统内核程序临界区`中。
   3. `在原子操作过程中（原语）`。原子操作不可中断，要一气呵成。

临界资源：一个时间段内只允许一个进程使用的资源。各进程需要互斥地访问临界资源。

临界区：访问临界资源的那段代码

注意：
1. 进程处于临界区时可以进行处理机调度
2. 进程在操作系统内核程序临界区中不能进行调度与切换。内核程序临界区一般是用来访问某种内核数据结构的。

## 3. 进程调度的方式

1. `非剥夺调度方式`：`非抢占方式`。只允许进程主动放弃处理机。在运行过程中即便有更紧迫的任务到达，当前进程依然会继续使用处理机，直到该进程终止或主动要求进入阻塞态。
    - 特点：`实现简单，系统开销小`但是`无法及时处理紧急任务`，适合于早期的批处理系统
2. `剥夺调度方式`：又称`抢占方式`。当一个进程正在处理机上执行时，如果有一个更重要或更紧迫的进程需要使用处理机，则立即暂停正在执行的进程，将处理机分配给更重要紧迫的那个进程。
    - 特点：`可以优先处理更紧急的进程，也可实现让各进程按时间片轮流执行的功能`（通过时钟中断）。适合于分时操作系统、实时操作系统

注意：
1. 狭义的进程调度 vs 进程切换 vs 广义的进程调度
   - 狭义的进程调度：`从就绪队列中选中一个要运行的进程`。
   - 进程切换：`让一个进程让出处理机，由另一进程占用处理机的过程`。
   - 广义的进程调度：`包含了选择一个进程和进程切换两个步骤`。
2. 进程切换主要完成了：
   1. 对原来运行进程各种数据的保存。
   2. 对新的进程各种数据的恢复。`进程切换是有代价的`，因此如果`过于频繁的进行进程调度、切换`，`必然会使整个系统的效率降低`，使系统大部分时间都花在了进程切换上，而真正用于执行进程的时间减少

## 4. 调度算法的评价指标

调度算法的评价指标包括：
1. CPU利用率
2. 系统吞吐量
3. 周转时间
   1. 周转时间、平均周转时间
   2. 带权周转时间、平均带权周转时间
4. 等待时间
5. 响应时间

### 4.1 CPU利用率

`CPU利用率`是指`CPU忙碌的时间占总时间的比例`。

通常会考察多道程序并发执行的情况，可以用甘特图来辅助计算。

### 4.2 系统吞吐量

`系统吞吐量`：单位时间内完成作业的数量。

`系统吞吐量 = 总共完成了多少道作业 / 总共花了多少时间`

### 4.3 周转时间

周转时间是指从作业被提交给系统开始，到作业完成为止这段时间间隔。

包括4个部分：
1. 作业在外存后备队列上等待作业调度（高级调度）的时间
2. 进程在就绪队列上等待进程调度（低级调度）的时间
3. 进程在CPU上执行的时间
4. 进程等待I/O操作完成的时间

`周转时间 = 作业完成时间 - 作业提交时间`

`平均周转时间 = 各作业周转时间之和 / 作业数`

`带权周转时间 = 作业周转时间 / 作业实际的运行时间 = （作业完成时间 - 作业提交时间） / 作业实际的运行时间`

`平均带权周转时间 = 各作业带权周转时间之和 / 作业数`

注意：
1. 带权周转时间必然>=1。
2. 带权周转时间和周转时间都是越小越好。

### 4.4 等待时间

等待时间，是指进程/作业处于等待处理机状态时间之和，等待时间越长，用户的满意度越低。

对于`进程`来说，等待时间是指`进程建立后等待被服务的时间之和`。在`等待I/O完成的期间其实进程也是在被服务的，所以不计入等待时间`。

对于`作业`来说，不仅要考虑`建立进程后的等待时间`，还要加上`作业在外存后备队列中等待的时间`。

### 4.5 响应时间

响应时间：用户提交请求到首次产生响应所用的时间。